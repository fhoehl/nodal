/*! nodal - v0.1.0 - 2012-10-04
* https://github.com/fhoehl/nodal
* Copyright (c) 2012 fhoehl; Licensed MIT */
(function(e){var t=this.window.document,n=this.window.location,r=this.window.navigator,i={model:{},view:{},layout:{},loader:{}};e.nodal=i,function(){var e={},t={},n=!0;typeof define!="undefined"?define([],function(){return e}):typeof window!="undefined"?window.move=e:module.exports=e,e.Object=function(){var t=arguments.length,n=arguments[t-1],i=t>1?arguments[0]:null,s=t>2,o,u;n.constructor===Object?o=function(){}:(o=n.constructor,delete n.constructor),i&&(u=function(){},u.prototype=i.prototype,o.prototype=new u,o.Super=u,r(o,u,!1));if(s){var a;for(a=1;a<t-1;a++)r(o.prototype,arguments[a].prototype,!1)}return o.prototype.bind=e.bind,o.prototype.unbind=e.unbind,o.prototype.trigger=e.trigger,r(o.prototype,n,!0),o},e.bind=function(e,t,n){this.events=this.events||{},this.events[e]=this.events[e]||[],this.events[e].push(t)},e.unbind=function(e,t){this.events=this.events||{};if(e in this.events==0)return;this.events[e].splice(this.events[e].indexOf(t),1)},e.trigger=function(e){n&&console.log("Event:",arguments),this.events=this.events||{};if(e in this.events==0)return;for(var t=0;t<this.events[e].length;t++)this.events[e][t].apply(this,Array.prototype.slice.call(arguments,1))};var r=function(e,t,n){var r;if(n===!1)for(r in t)r in e||(e[r]=t[r]);else{for(r in t)e[r]=t[r];t.toString!==Object.prototype.toString&&(e.toString=t.toString)}}}(),i.loader={loadJSON:function(e){var t=new i.model.Graph,n,r,s,o,u={},a={},f,l,c,h;return e.vertices&&(n=e.vertices,n.forEach(function(e){u[e._id]=t.v.add(e._id,e)})),e.edges&&(r=e.edges,r.forEach(function(e){c=e._inV.split(":"),h=e._outV.split(":"),f=u[c[0]],l=u[h[0]],f&&l&&t.e.add(f,c[1],l,h[1],e._label,e)})),t}},i.model.Graph=function(){this.vertices=[],this.edges=[],this.adjacency={},_this=this,this.v={all:this.vertices,add:this.addVertex.bind(this)},this.e={all:this.edges,add:this.addEdge.bind(this)}},i.model.Graph.prototype={addVertex:function(e,t){var n=new i.model.Vertex(e,t);return n.id in this.adjacency||(this.vertices.push(n),this.adjacency[n.id]=n),n},getVertex:function(e){return this.adjacency[e]},addEdge:function(e,t,n,r,s,o){var u=!1,a=null,f,l;if(this.vertices.indexOf(e)>-1&&this.vertices.indexOf(n)>-1){for(f=0;a=this.edges[f];f++)a.inV==e&&a.outV==n&&delete this.edges[f];return a=new i.model.Edge(s,o),a.inV=e,a.inVIndex=r,a.outV=n,a.outVIndex=t,this.edges.push(a),a}return!1},deleteVertex:function(e){var t=this.vertices.indexOf(e);t>-1&&this.vertices.splice(t,1),this.edges.forEach(function(t){if(t.inV===e||t.outV===e)t.inV=t.outV=null},this)},deleteEdge:function(e){var t=this.edges.indexOf(e);t>-1&&this.edges.splice(t,1)},toBooleanMatrix:function(e){var t=this.vertices.length,n=i.math.matrix.zero(t,t),r,s;return this.edges.forEach(function(e){r=this.vertices.indexOf(e.inV),s=this.vertices.indexOf(e.outV),r>-1&&s>-1&&(n[r][s]=1)},this),n},toMatrix:function(){var e=this.vertices.length,t=i.math.matrix.zero(e,e),n,r;return this.edges.forEach(function(e){n=this.vertices.indexOf(e.inV),r=this.vertices.indexOf(e.outV),n>-1&&r>-1&&(t[n][r]=e.props.weight)},this),t}},i.model.Vertex=function(e,t){var n=null;this.id=e||"",this.props=t||{},this.inSockets=this.props.inputs,this.outSockets=this.props.outputs,this.evaluate=this.props.evaluate||function(){return 0}},i.model.Edge=function(e,t){var n=null;this.label=e||"",this.inV=null,this.inVIndex=0,this.outV=null,this.outVIndex=0,this.props=t||{}},i.view.VertexView=move.Object({el:null,outEl:[],inEl:[],model:null,constructor:function(e,t,n,r){this.model=e,this.render(t,n,r)},render:function(e,n,r){var i=t.createElement("div");i.className="vertex "+e,i.id="vertex-"+NodeEd.idX++,i.style.left="0px",i.style.top="0px",i.setAttribute("data-nodeType",e),i.setAttribute("data-vertexId",NodeEd.idX);var s=t.createElement("div");s.className="content",i.appendChild(s);var o=t.createElement("a");o.className="label",o.appendChild(t.createTextNode(e)),o.addEventListener("mousedown",this.startDrag.bind(this),!0),s.appendChild(o);var u=$("#"+e);console.log(u.html());if(u.length>0){var a=$(u.html()),f=this;$(s).append(a),$(":input[nd-input]",a.parent()).each(function(e,t){var n=$(t).attr("nd-input");f.bind("node-output-data-change",function(e){$(t).val(f.model.inSockets[n].data)})}),$(":input[nd-output]",a.parent()).each(function(e,t){var n=$(t).attr("nd-output");$(t).on("change",function(e){console.log("change change",e),f.model.outSockets[0].data=$(t).val(),f.trigger("node-output-data-change",{outputId:n,data:$(t).val(),node:this.model})})}),$(":input[nd-prop]",a.parent()).each(function(e,t){var n=$(t).attr("nd-prop");$(t).on("change",function(e){f.model.props[n]=e.target.value})})}var l=t.createElement("div");l.className="input-anchors anchors",i.appendChild(l);if(n){var c=0,h=[];for(var p in n){var d=t.createElement("div");d.className="anchor node-input",d.setAttribute("data-vertexId",NodeEd.idX),d.setAttribute("data-anchorId",c++),d.addEventListener("mousedown",this.startAnchorDrag.bind(this),!1),d.innerHTML="<span class='button'>&nbsp;</span>",l.appendChild(d),h.push(d)}this.inEl=h}var v=t.createElement("div");v.className="output-anchors anchors",i.appendChild(v);if(r){var c=0,m=[];for(var p in r){var d=t.createElement("div");d.className="anchor node-output",d.setAttribute("data-vertexId",NodeEd.idX),d.setAttribute("data-anchorId",c++),d.addEventListener("mousedown",this.startAnchorDrag.bind(this),!0),d.innerHTML="<span class='button'>&nbsp;</span>",v.appendChild(d),m.push(d)}this.outEl=m}var g=t.createElement("div");g.className="footer",g.innerHTML="<span>&nbsp;</span>",i.appendChild(g);var y=t.createElement("a");y.href="#",y.className="close",y.addEventListener("mouseclick",NodeEd.deleteNodeHandler,!0),this.el=i},startDrag:function(e){console.log(e.target,e.currentTarget,e.target.parentNode);if(!e.target.classList.contains("label"))return;var n=e.clientX+window.scrollX,r=e.clientY+window.scrollY;this.cursorStartX=n,this.cursorStartY=r,this.elStartLeft=parseInt(this.el.style.left,10),this.elStartTop=parseInt(this.el.style.top,10),$(t).on("mousemove",this.drag.bind(this)),$(t).on("mouseup",this.endDrag.bind(this)),e.preventDefault(),e.stopPropagation(),this.trigger("start-drag")},drag:function(e){var t=e.clientX+window.scrollX,n=e.clientY+window.scrollY;this.el.style.left=this.elStartLeft+t-this.cursorStartX+"px",this.el.style.top=this.elStartTop+n-this.cursorStartY+"px",e.preventDefault(),e.stopPropagation(),this.trigger("drag",{vertex:this})},endDrag:function(e){$(t).off("mousemove"),$(t).off("mouseup"),e.preventDefault(),e.stopPropagation(),this.trigger("end-drag",{vertex:this})},startAnchorDrag:function(e){$(t).on("mousemove",this.anchorDrag.bind(this)),$(t).on("mouseup",this.endAnchorDrag.bind(this)),this.selectedAnchorEl=e.target.parentNode,this.trigger("start-anchor-drag",{vertex:this,anchorEl:e.target.parentNode}),e.preventDefault(),e.stopPropagation()},anchorDrag:function(e){e.preventDefault(),e.stopPropagation(),this.trigger("anchor-drag",{vertex:this,srcAnchorEl:this.selectedAnchorEl,mouseEvent:e})},endAnchorDrag:function(e){$(t).off("mousemove"),$(t).off("mouseup"),e.preventDefault(),e.stopPropagation(),this.trigger("end-anchor-drag",{vertex:this,srcAnchorEl:this.selectedAnchorEl,dstEl:e.target})}}),i.view.LinkView=move.Object({el:null,inEl:null,outEl:null,constructor:function(e,n,r,i){var s="http://www.w3.org/2000/svg",o=t.createElementNS(s,"line"),u=$(n).offset().left+12,a=$(n).offset().top+12,f=$(i).offset().left+12,l=$(i).offset().top+12;o.setAttributeNS(null,"x1",u),o.setAttributeNS(null,"y1",a),o.setAttributeNS(null,"x2",f),o.setAttributeNS(null,"y2",l),o.setAttributeNS(null,"stroke","black"),o.setAttributeNS(null,"stroke-width","5"),this.el=o,this.src=e,this.srcAnchorEl=n,this.dst=r,this.dstAnchorEl=i},render:function(e,t,n,r){var i=this.el;i.setAttributeNS(null,"x1",e),i.setAttributeNS(null,"y1",t),i.setAttributeNS(null,"x2",n),i.setAttributeNS(null,"y2",r)}}),i.view.GraphView=move.Object({verticesEl:null,verticesViews:[],verticesIds:{},linksEl:null,linksViews:[],layout:null,constructor:function(e){var n=t.getElementById(e);this.verticesEl=t.createElement("div"),this.verticesEl.id=e+"-vertices",this.verticesEl.className="vertices";var r=t.createElement("div");r.id=e+"-links",r.className="links",this.linksEl=t.createElementNS("http://www.w3.org/2000/svg","svg"),r.appendChild(this.linksEl),n.appendChild(r),n.appendChild(this.verticesEl)},addLink:function(e){this.linksViews.push(e),this.linksEl.appendChild(e.el)},addVertex:function(e){this.verticesViews.push(e),this.verticesEl.appendChild(e.el),e.bind("drag",function(e){var t=e.vertex;this.linksViews.forEach(function(e){if(e.src==t||e.dst==t){var n=$(e.srcAnchorEl).offset().left+12,r=$(e.srcAnchorEl).offset().top+12,i=$(e.dstAnchorEl).offset().left+12,s=$(e.dstAnchorEl).offset().top+12;e.render(n,r,i,s)}},this)}.bind(this)),e.bind("anchor-drag",function(e){if(!this.anchorDragEdgeEl){var n="http://www.w3.org/2000/svg",r=t.createElementNS(n,"line");this.anchorDragEdgeEl=r,this.linksEl.appendChild(r)}var i=$(e.srcAnchorEl),s=i.offset().left+12,o=i.offset().top+12,u=e.mouseEvent.clientX+window.scrollX,a=e.mouseEvent.clientY+window.scrollY;this.anchorDragEdgeEl.setAttributeNS(null,"x1",s),this.anchorDragEdgeEl.setAttributeNS(null,"y1",o),this.anchorDragEdgeEl.setAttributeNS(null,"x2",u),this.anchorDragEdgeEl.setAttributeNS(null,"y2",a),this.anchorDragEdgeEl.setAttributeNS(null,"stroke","black"),this.anchorDragEdgeEl.setAttributeNS(null,"stroke-width","5")}.bind(this)),e.bind("end-anchor-drag",function(e){var t=null;this.linksEl.removeChild(this.anchorDragEdgeEl),this.anchorDragEdgeEl=null,e.dstEl.classList.contains("button")&&(t=e.dstEl.parentNode,dstVertexId=t.getAttribute("data-vertexId"),this.trigger("add-edge",{srcVertexId:e.vertex.el.getAttribute("data-vertexId"),srcVertexAnchorId:e.srcAnchorEl.getAttribute("data-anchorId"),dstVertexId:t.getAttribute("data-vertexId"),dstVertexAnchorId:t.getAttribute("data-anchorId")}))}.bind(this))},updateLayout:function(){this.layout&&this.layout.update(this.verticesViews,this.linksViews)},renderEdge:function(e){var t=this.verticesIds[e.inV.props._id],n=this.verticesIds[e.outV.props._id];srcAnchorEl=t.outEl[e.outVIndex],dstAnchorEl=n.inEl[e.inVIndex];var r=new i.view.LinkView(t,srcAnchorEl,n,dstAnchorEl);this.addLink(r)},render:function(e){var t=e,n={};t.v.all.forEach(function(e){var t=new i.view.VertexView(e,e.props._type,e.props.inputs,e.props.outputs);n[e.props._id]=t,this.verticesIds[e.props._id]=t,this.addVertex(t)},this),this.updateLayout(),t.e.all.forEach(function(e){var t=n[e.inV.props._id],r=n[e.outV.props._id];srcAnchorEl=t.outEl[e.outVIndex],dstAnchorEl=r.inEl[e.inVIndex];var s=new i.view.LinkView(t,srcAnchorEl,r,dstAnchorEl);this.addLink(s),t.bind("node-output-data-change",function(t){e.outV.inSockets[e.inVIndex].data=t.data,console.log("=>",e);var n=e.outV.evaluate(r);r.trigger("node-output-data-change",{outputId:e.inVIndex,data:n.data,node:r.model})})},this)}}),NodeEd={idX:0},i.layout.Random=move.Object({constructor:function(){},update:function(e){e.forEach(function(e){e.el.style.left=Math.random()*window.innerWidth+"px",e.el.style.top=Math.random()*window.innerHeight+"px"})}}),i.layout.Grid=move.Object({constructor:function(){},update:function(e){var t=0,n=0,r=40,i=40,s=0;e.forEach(function(e){e.el.style.left=t+"px",e.el.style.top=n+"px",e.el.offsetHeight>s&&(s+=e.el.offsetHeight),t+=parseInt(e.el.offsetWidth,10)+r,t>window.innerWidth-parseInt(e.el.offsetHeight,10)&&(t=0,n+=parseInt(e.el.offsetHeight,10)+i,s=0)})}})})(typeof exports=="object"&&exports||this);